<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Yönetici Paneli | Dilek Pastanesi</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { --primary-color: #c0392b; --dark-bg: #2c3e50; --text-color: #333; }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Poppins', sans-serif; background-color: #ecf0f1; color: var(--text-color); }

        .navbar { background: var(--dark-bg); padding: 1rem 5%; display: flex; justify-content: space-between; align-items: center; color: white; position: sticky; top: 0; z-index: 100; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .navbar h1 { font-family: 'Playfair Display', serif; font-size: 1.5rem; }
        .logout-btn { color: #ecf0f1; text-decoration: none; padding: 8px 15px; border: 1px solid transparent; border-radius: 5px; transition: 0.3s; }
        .logout-btn:hover { border-color: #fff; background: rgba(255,255,255,0.1); }

        .dashboard-container { padding: 2rem 5%; max-width: 1200px; margin: 0 auto; }

        /* İstatistik Kartları */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1.5rem; margin-bottom: 2rem; }
        .stat-card { background: white; padding: 1.5rem; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); text-align: center; border-bottom: 4px solid var(--primary-color); }
        .stat-card p { font-size: 2rem; font-weight: 700; color: var(--dark-bg); margin-top: 5px; }

        /* FİLTRE ALANI (YENİ) */
        .filter-section {
            background: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            display: flex;
            gap: 15px;
            align-items: flex-end;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            flex-wrap: wrap;
        }
        .filter-group { display: flex; flex-direction: column; gap: 5px; }
        .filter-group label { font-size: 0.85rem; color: #666; font-weight: 600; }
        .filter-group input { padding: 8px 12px; border: 1px solid #ddd; border-radius: 6px; font-family: 'Poppins', sans-serif; }
        
        .filter-btn {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: 0.3s;
            height: 40px;
        }
        .filter-btn:hover { background: #a93226; }
        .reset-btn { background: #95a5a6; }
        .reset-btn:hover { background: #7f8c8d; }

        /* Liste ve Kartlar */
        .feedback-list { display: flex; flex-direction: column; gap: 20px; }
        .feedback-item { background: white; padding: 25px; border-radius: 15px; box-shadow: 0 2px 15px rgba(0,0,0,0.05); }
        .feedback-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 15px; }
        .user-meta h4 { font-size: 1.2rem; color: #2c3e50; font-weight: 600; }
        .feedback-date { font-size: 0.85rem; color: #95a5a6; }
        .star-rating { color: #f1c40f; letter-spacing: 2px; }
        .feedback-message { background: #f9f9f9; padding: 15px; border-radius: 8px; font-style: italic; color: #555; margin-bottom: 20px; border-left: 3px solid #ddd; }

        /* Detay Grid */
        .details-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(130px, 1fr)); gap: 10px; }
        .detail-box { background: #fff; border: 1px solid #eee; border-radius: 8px; padding: 8px; font-size: 0.8rem; display: flex; flex-direction: column; }
        .detail-title { color: #999; font-size: 0.7rem; text-transform: uppercase; font-weight: 600; margin-bottom: 3px; }
        .detail-value { font-weight: 600; color: #333; }
        
        .text-harika { color: #27ae60; } .text-iyi { color: #2980b9; } .text-ortalama { color: #f39c12; } .text-zayif { color: #c0392b; }

        @media (max-width: 768px) { .filter-section { flex-direction: column; align-items: stretch; } }
    </style>
</head>
<body>

    <nav class="navbar">
        <h1>Dilek Pastanesi <span style="font-size:0.8em; opacity:0.8;">| Yönetici</span></h1>
        <a href="index.html" class="logout-btn"><i class="fas fa-sign-out-alt"></i> Çıkış</a>
    </nav>

    <div class="dashboard-container">
        <div class="stats-grid">
            <div class="stat-card">
                <i class="fas fa-users" style="color:var(--primary-color); font-size:2rem;"></i>
                <h3>Toplam</h3>
                <p id="totalCount">...</p>
            </div>
            <div class="stat-card" style="border-color: #f1c40f;">
                <i class="fas fa-star" style="color: #f1c40f; font-size:2rem;"></i>
                <h3>Ortalama</h3>
                <p id="avgRating">...</p>
            </div>
            <div class="stat-card" style="border-color: #27ae60;">
                <i class="fas fa-calendar-check" style="color: #27ae60; font-size:2rem;"></i>
                <h3>Bugün</h3>
                <p id="todayCount">...</p>
            </div>
        </div>

        <div class="filter-section">
            <div class="filter-group">
                <label>Başlangıç Tarihi:</label>
                <input type="date" id="startDate">
            </div>
            <div class="filter-group">
                <label>Bitiş Tarihi:</label>
                <input type="date" id="endDate">
            </div>
            <div style="display:flex; gap:10px; margin-top: auto;">
                <button class="filter-btn" onclick="filtrele()">Filtrele</button>
                <button class="filter-btn reset-btn" onclick="filtreyiTemizle()">Temizle</button>
            </div>
        </div>
        
        <div id="feedbackContainer" class="feedback-list">
            <div style="text-align:center; padding:50px; color:#999;">Veriler yükleniyor...</div>
        </div>
    </div>

    <script>
        const sifre = prompt("Yönetici Şifresi:");
        if (sifre !== "restoran2025") { window.location.href = "index.html"; }

        let tumVeriler = []; // Tüm verileri burada tutacağız

        function getColorClass(v) {
            if(!v) return ''; v = v.toLowerCase();
            if(v.includes('harika')) return 'text-harika';
            if(v.includes('iyi')) return 'text-iyi';
            if(v.includes('ortalama')) return 'text-ortalama';
            if(v.includes('zayıf') || v.includes('değil')) return 'text-zayif';
            return '';
        }

        function generateStars(count) {
            let s = ''; for(let i=1; i<=5; i++) s += i<=count ? '<i class="fas fa-star"></i>' : '<i class="far fa-star" style="color:#ddd;"></i>'; return s;
        }

        async function verileriGetir() {
            try {
                const res = await fetch('/api/feedbacks');
                tumVeriler = await res.json();
                verileriEkranaBas(tumVeriler); // İlk açılışta hepsini göster
                istatistikleriGuncelle(tumVeriler);
            } catch (err) { console.error(err); }
        }

        function verileriEkranaBas(veriler) {
            const container = document.getElementById('feedbackContainer');
            container.innerHTML = "";

            if (veriler.length === 0) {
                container.innerHTML = "<p style='text-align:center; padding:20px;'>Bu tarih aralığında veri bulunamadı.</p>";
                return;
            }

            veriler.forEach(item => {
                const dateObj = new Date(item.date);
                const formattedDate = dateObj.toLocaleDateString('tr-TR', { day: 'numeric', month: 'long', year: 'numeric', hour: '2-digit', minute:'2-digit' });

                const detailBox = (t, v, i) => `<div class="detail-box"><span class="detail-title"><i class="fas ${i}"></i> ${t}</span><span class="detail-value ${getColorClass(v)}">${v||'-'}</span></div>`;

                const html = `
                    <div class="feedback-item">
                        <div class="feedback-header">
                            <div class="user-meta">
                                <h4>${item.fullname || 'İsimsiz'} ${item.fullname?'':'<span style="font-size:0.7rem; background:#eee; padding:2px 5px; border-radius:4px;">Anonim</span>'}</h4>
                                <div class="feedback-date"><i class="far fa-clock"></i> ${formattedDate}</div>
                            </div>
                            <div class="star-rating">${generateStars(item.general_star_rating||0)}</div>
                        </div>
                        ${item.message ? `<div class="feedback-message"><i class="fas fa-quote-left"></i> ${item.message}</div>` : ''}
                        <div class="details-grid">
                            ${detailBox('Karşılama', item.welcome_farewell, 'fa-door-open')} 
                            ${detailBox('Yemek', item.food_quality, 'fa-utensils')}
                            ${detailBox('Servis', item.service_quality, 'fa-concierge-bell')}
                            ${detailBox('Hız', item.service_speed, 'fa-tachometer-alt')}
                            ${detailBox('İlgi', item.staff_interest, 'fa-smile')}
                            ${detailBox('Temizlik', item.cleanliness, 'fa-broom')}
                            ${detailBox('Ortam', item.ambiance, 'fa-couch')}
                            ${detailBox('Müzik', item.music, 'fa-music')}
                            ${detailBox('Lezzet', item.taste, 'fa-pizza-slice')}
                        </div>
                    </div>`;
                container.innerHTML += html;
            });
        }

        function istatistikleriGuncelle(veriler) {
            document.getElementById('totalCount').innerText = veriler.length;
            const avg = veriler.length > 0 ? (veriler.reduce((s, i) => s + (i.general_star_rating||0), 0) / veriler.length).toFixed(1) : "0.0";
            document.getElementById('avgRating').innerText = avg;
            const bugun = new Date().toLocaleDateString('tr-TR');
            const bugunSayi = veriler.filter(i => new Date(i.date).toLocaleDateString('tr-TR') === bugun).length;
            document.getElementById('todayCount').innerText = bugunSayi;
        }

        function filtrele() {
            const baslangic = document.getElementById('startDate').value;
            const bitis = document.getElementById('endDate').value;

            if (!baslangic || !bitis) { alert("Lütfen iki tarihi de seçiniz."); return; }

            const basTarih = new Date(baslangic); basTarih.setHours(0,0,0,0);
            const bitTarih = new Date(bitis); bitTarih.setHours(23,59,59,999);

            const filtrelenmis = tumVeriler.filter(item => {
                const itemDate = new Date(item.date);
                return itemDate >= basTarih && itemDate <= bitTarih;
            });

            verileriEkranaBas(filtrelenmis);
        }

        function filtreyiTemizle() {
            document.getElementById('startDate').value = "";
            document.getElementById('endDate').value = "";
            verileriEkranaBas(tumVeriler);
        }

        verileriGetir();
    </script>
</body>
</html>